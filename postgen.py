import random
from datetime import datetime
from parser import extract_text
from openai import OpenAI
import os
import sqlite3
from dotenv import load_dotenv

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Init
load_dotenv()
OPENAI_KEY = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=OPENAI_KEY)
DB_PATH = "mukhomorda.db"

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –¢–µ–º—ã (—Ä—É—á–Ω—ã–µ)
TOPICS = [
    "üü• –ú—É—Ö–æ–º–æ—Ä –∏ –º–∏–∫—Ä–æ–¥–æ–∑–∏–Ω–≥",
    "üü´ –ß–∞–≥–∞: –≥—Ä–∏–± –±–µ—Å—Å–º–µ—Ä—Ç–∏—è",
    "üü® –ö–æ—Ä–¥–∏—Ü–µ–ø—Å –∏ —ç–Ω–µ—Ä–≥–∏—è",
    "üü© –ï–∂–æ–≤–∏–∫ –≥—Ä–µ–±–µ–Ω—á–∞—Ç—ã–π ‚Äî –≥—Ä–∏–± –º–æ–∑–≥–∞",
    "üçÑ –ú–∏—Ñ–æ–ª–æ–≥–∏—è –∏ –¥—É—Ö–∏ –≥—Ä–∏–±–æ–≤"
]

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É
def save_post_to_db(title, content):
    with sqlite3.connect(DB_PATH) as conn:
        cur = conn.cursor()
        cur.execute("INSERT INTO posts (title, content) VALUES (?, ?)", (title, content))
        conn.commit()
        print(f"[DB] –°–æ—Ö—Ä–∞–Ω—ë–Ω –ø–æ—Å—Ç: {title}")

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–æ—Å—Ç –ø–æ —à–∞–±–ª–æ–Ω—É
def generate_post():
    topic = random.choice(TOPICS)
    body = {
        "üü• –ú—É—Ö–æ–º–æ—Ä –∏ –º–∏–∫—Ä–æ–¥–æ–∑–∏–Ω–≥": (
            "–ú—É—Ö–æ–º–æ—Ä ‚Äî –Ω–µ —è–¥, –∞ —Å–æ—é–∑–Ω–∏–∫. –í –º–∏–∫—Ä–æ–¥–æ–∑–∞—Ö –æ–Ω –ø–æ–º–æ–≥–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å, "
            "—É–º–µ–Ω—å—à–∏—Ç—å —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç —Å —Ç–µ–ª–æ–º.\n\n"
            "#–º—É—Ö–æ–º–æ—Ä #–º–∏–∫—Ä–æ–¥–æ–∑–∏–Ω–≥ #–≥—Ä–∏–±—ã"
        ),
        "üü´ –ß–∞–≥–∞: –≥—Ä–∏–± –±–µ—Å—Å–º–µ—Ä—Ç–∏—è": (
            "–ß–∞–≥–∞ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–º—É –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è, –ø–æ–≤—ã—à–∞–µ—Ç –∏–º–º—É–Ω–∏—Ç–µ—Ç –∏ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç —ç–Ω–µ—Ä–≥–∏–µ–π. "
            "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∫–∞–º–∏ –Ω–∞ –°–µ–≤–µ—Ä–µ –∫–∞–∫ –ª–µ–∫–∞—Ä—Å—Ç–≤–æ.\n\n"
            "#—á–∞–≥–∞ #–∞–¥–∞–ø—Ç–æ–≥–µ–Ω #–∑–¥–æ—Ä–æ–≤—å–µ"
        ),
        "üü® –ö–æ—Ä–¥–∏—Ü–µ–ø—Å –∏ —ç–Ω–µ—Ä–≥–∏—è": (
            "–ö–æ—Ä–¥–∏—Ü–µ–ø—Å ‚Äî –≥—Ä–∏–±, –ø–æ–≤—ã—à–∞—é—â–∏–π –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å. –ï–≥–æ –≤—ã–±–∏—Ä–∞—é—Ç —Å–ø–æ—Ä—Ç—Å–º–µ–Ω—ã –∏ –º–æ–Ω–∞—Ö–∏. "
            "–í–æ—Å—Ç–æ—á–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω–∞ –∑–Ω–∞–µ—Ç –µ–≥–æ —Ç—ã—Å—è—á–∏ –ª–µ—Ç.\n\n"
            "#–∫–æ—Ä–¥–∏—Ü–µ–ø—Å #—ç–Ω–µ—Ä–≥–∏—è #–∞–¥–∞–ø—Ç–æ–≥–µ–Ω"
        ),
        "üü© –ï–∂–æ–≤–∏–∫ –≥—Ä–µ–±–µ–Ω—á–∞—Ç—ã–π ‚Äî –≥—Ä–∏–± –º–æ–∑–≥–∞": (
            "–ï–∂–æ–≤–∏–∫ —Å—Ç–∏–º—É–ª–∏—Ä—É–µ—Ç —Ä–æ—Å—Ç –Ω–µ–π—Ä–æ–Ω–æ–≤. –£–ª—É—á—à–∞–µ—Ç –ø–∞–º—è—Ç—å, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –∏ —è—Å–Ω–æ—Å—Ç—å —É–º–∞. "
            "–ò–¥–µ–∞–ª–µ–Ω —Å –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞–º–∏.\n\n"
            "#–µ–∂–æ–≤–∏–∫ #–Ω–µ–π—Ä–æ–ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å #–Ω–æ–æ—Ç—Ä–æ–ø"
        ),
        "üçÑ –ú–∏—Ñ–æ–ª–æ–≥–∏—è –∏ –¥—É—Ö–∏ –≥—Ä–∏–±–æ–≤": (
            "–ì—Ä–∏–±—ã ‚Äî –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∏ –º–µ–∂–¥—É –º–∏—Ä–∞–º–∏. –®–∞–º–∞–Ω—ã –∏ —Ç—Ä–∞–≤–Ω–∏–∫–∏ –≤–µ–∫–∞–º–∏ "
            "–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∏—Ö –∫–∞–∫ –¥—É—Ö–æ–≤–Ω—ã—Ö —Å–æ—é–∑–Ω–∏–∫–æ–≤.\n\n"
            "#–≥—Ä–∏–±–Ω–æ–π–º–∏—Ä #–º–∏—Ñ–æ–ª–æ–≥–∏—è #–¥—É—Ö–∏–ª–µ—Å–∞"
        ),
    }

    post = {
        "title": topic,
        "content": body[topic],
        "created_at": datetime.now().isoformat()
    }

    save_post_to_db(post["title"], post["content"])
    return post

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–æ—Å—Ç –∏–∑ PDF
def generate_from_pdf():
    raw_text = extract_text()[:3000]
    prompt = (
        f"–í–æ—Ç –≤—ã–¥–µ—Ä–∂–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ –º–∏–∫—Ä–æ–¥–æ–∑–∏–Ω–≥–µ:\n\n{raw_text}\n\n"
        "–ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –Ω–∞–ø–∏—à–∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π Telegram-–ø–æ—Å—Ç –ø—Ä–æ –≥—Ä–∏–±—ã. "
        "–î–æ–±–∞–≤—å –∑–∞–≥–æ–ª–æ–≤–æ–∫, —ç–º–æ–¥–∑–∏, —Ö–µ—à—Ç–µ–≥–∏. –ü–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ—ç—Ç–∏—á–Ω—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º."
    )–©–∞

    response = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": prompt}],
        max_tokens=400,
        temperature=0.8,
    )

    content = response.choices[0].message.content.strip()
    title = content.split("\n")[0]
    body = "\n".join(content.split("\n")[1:])

    save_post_to_db(title, body)

    return {
        "title": title,
        "content": body,
        "created_at": datetime.now().isoformat()
    }
